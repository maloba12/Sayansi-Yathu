<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Chemistry Lab ‚Äì Sayansi Yathu</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/simulation-player.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        :root {
            --sidebar-width: 280px;
            --right-panel-width: 320px;
        }

        .lab-layout {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr var(--right-panel-width);
            height: calc(100vh - 64px);
            overflow: hidden;
            background: #f0f2f5;
        }

        /* Left Sidebar: Tools & Materials */
        .tools-panel {
            background: white;
            border-right: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            padding: var(--space-lg);
            overflow-y: auto;
        }

        .tool-category {
            margin-bottom: var(--space-xl);
        }

        .tool-category h4 {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--gray-500);
            letter-spacing: 0.05em;
            margin-bottom: var(--space-md);
        }

        .tool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-sm);
        }

        .tool-item {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            touch-action: none; /* Prevent scrolling while dragging-spawn */
        }

        .tool-item:hover {
            border-color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .tool-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
            display: block;
        }

        .tool-name {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--gray-700);
        }

        /* Center area: Lab Bench */
        .bench-container {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .bench-header {
            background: white;
            padding: var(--space-md) var(--space-xl);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #lab-canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #e5e7eb; /* Table color */
            overflow: hidden;
        }

        .bench-surface {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 40%;
            background: #d1d5db; /* Bench surface color */
            border-top: 4px solid #9ca3af;
            pointer-events: none; /* Don't block canvas clicks */
        }

        /* Right Panel: Instructions & Observation */
        .info-panel {
            background: white;
            border-left: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .info-section {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--gray-100);
        }

        .info-section h3 {
            font-size: 1rem;
            margin-bottom: var(--space-sm);
            color: var(--primary-blue);
        }

        .procedure-steps {
            padding-left: var(--space-lg);
        }

        .procedure-steps li {
            font-size: 0.9rem;
            margin-bottom: var(--space-sm);
            color: var(--gray-700);
            line-height: 1.5;
        }

        .procedure-steps li.active {
            color: var(--primary-blue);
            font-weight: 600;
        }

        .safety-box {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin: var(--space-md);
            font-size: 0.85rem;
            color: #c53030;
        }

        /* Overlay */
        .mode-indicator {
            position: absolute;
            top: var(--space-md);
            left: var(--space-md);
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            z-index: 10;
        }

        .mode-student { background: #ebf8ff; color: #2b6cb0; }
        .mode-teacher { background: #f0fff4; color: #276749; }

        .hidden { display: none; }
    </style>
</head>
<body>
    <nav class="navbar" style="height: 64px;">
        <div class="container navbar-content">
            <div class="logo-container">
                <img src="assets/logo1.jpeg" alt="Sayansi Yathu" class="logo-image">
                <span class="brand-name">Sayansi Yathu</span>
            </div>
            <div class="flex gap-md align-center">
                <span id="experimentTitle" class="font-bold">Experiment Title</span>
                <div class="flex gap-sm">
                    <button class="btn btn-outline" id="toggleModeBtn">Teacher Mode</button>
                    <button class="btn btn-primary" onclick="window.location.href='chemistry-form1.html'">Exit Lab</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="lab-layout">
        <!-- Left: Tools & Materials -->
        <aside class="tools-panel">
            <div class="tool-category">
                <h4>Glassware</h4>
                <div class="tool-grid">
                    <div class="tool-item" data-type="beaker" draggable="false">
                        <span class="tool-icon">ü•õ</span>
                        <span class="tool-name">Beaker</span>
                    </div>
                    <div class="tool-item" data-type="test_tube" draggable="false">
                        <span class="tool-icon">üß™</span>
                        <span class="tool-name">Test Tube</span>
                    </div>
                    <div class="tool-item" data-type="measuring_cylinder">
                        <span class="tool-icon">üìè</span>
                        <span class="tool-name">M. Cylinder</span>
                    </div>
                    <div class="tool-item" data-type="funnel">
                        <span class="tool-icon">‚ñΩ</span>
                        <span class="tool-name">Funnel</span>
                    </div>
                </div>
            </div>

            <div class="tool-category">
                <h4>Apparatus</h4>
                <div class="tool-grid">
                    <div class="tool-item" data-type="bunsen_burner" draggable="false">
                        <span class="tool-icon">üî•</span>
                        <span class="tool-name">Burner</span>
                    </div>
                    <div class="tool-item" data-type="tripod" draggable="false">
                        <span class="tool-icon">ü™ú</span>
                        <span class="tool-name">Tripod</span>
                    </div>
                    <div class="tool-item" data-type="litmus_red" draggable="false">
                        <span class="tool-icon">üü•</span>
                        <span class="tool-name">Litmus (R)</span>
                    </div>
                    <div class="tool-item" data-type="litmus_blue" draggable="false">
                        <span class="tool-icon">üü¶</span>
                        <span class="tool-name">Litmus (B)</span>
                    </div>
                </div>
            </div>

            <div class="tool-category">
                <h4>Materials</h4>
                <div class="tool-grid" id="materialsGrid">
                    <!-- Dynamic materials based on experiment -->
                </div>
            </div>
        </aside>

        <!-- Center: Simulation Workspace -->
        <main class="bench-container">
            <div id="modeBadge" class="mode-indicator mode-student">Student Mode</div>
            <div id="lab-canvas-container">
                <div class="bench-surface"></div>
                <!-- p5 canvas will be injected here -->
            </div>
            
            <div class="bench-header">
                <div class="flex gap-md">
                    <button class="btn btn-secondary btn-sm" id="resetBenchBtn">üîÑ Reset Bench</button>
                    <button class="btn btn-outline btn-sm" id="undoBtn">‚Ü™Ô∏è Undo</button>
                </div>
                <div class="flex gap-md align-center">
                    <label class="text-xs font-bold text-gray">Simulation Speed:</label>
                    <input type="range" min="0.5" max="2" step="0.1" value="1" id="speedSlider">
                </div>
            </div>
        </main>

        <!-- Right: Instructions & Observations -->
        <aside class="info-panel">
            <div class="info-section">
                <h3>Aim</h3>
                <p id="expAim" class="text-sm text-gray">Loading...</p>
            </div>

            <div class="info-section">
                <h3>Procedure</h3>
                <ol class="procedure-steps" id="expProcedure">
                    <!-- Steps here -->
                </ol>
                <div class="flex gap-sm mt-md">
                    <button class="btn btn-secondary btn-sm" id="prevStepBtn" disabled>Prev</button>
                    <button class="btn btn-primary btn-sm" id="nextStepBtn">Next Step</button>
                </div>
            </div>

            <div class="info-section">
                <h3>Observations</h3>
                <div id="expObservations" class="text-sm italic text-blue">
                    Awaiting observation...
                </div>
            </div>

            <div class="safety-box" id="expSafety">
                <strong>‚ö†Ô∏è Safety:</strong> <span>Loading...</span>
            </div>

            <div style="margin-top: auto; padding: var(--space-lg); background: var(--gray-50);">
                <span class="text-xs text-gray" id="cdcTag">Syllabus: CDC 2024</span>
            </div>
        </aside>
    </div>

    <!-- Scripts -->
    <script src="js/lab-audio.js?v=2"></script>
    <script src="js/chemistry-lab-engine.js?v=2"></script>
    <script>
      // --- Enhanced Realism Render Glue, uses engine state (no content/flow edits) ---
      window.addEventListener('DOMContentLoaded', function () {
        // Wait for p5 instance from engine
        function setupVisualHooks() {
          const engine = window.labEngine;
          if (!engine || !engine.p) return setTimeout(setupVisualHooks, 100);

          // LOD check for performance
          let LOD = window.deviceMemory && window.deviceMemory < 3 ? 0.65 : 1.0;

          const p = engine.p;
          // Patch original display logic with realism overlays
          const origDisplay = p.constructor.prototype.displayApparatus;
          p.constructor.prototype.displayApparatus = function(obj) {
            // Setup for natural ambient light, soft shadow, bench reflectivity
            // --- Shadow ---
            p.push();
            p.noStroke();
            p.fill(0,0,0, 50 * obj.glassShadowRatio * LOD);
            p.ellipse(obj.x, obj.y + obj.h/2, obj.w * 0.87, 13*LOD);
            p.pop();
            // --- Meniscus ---
            if(obj.liquidLevel > 0) {
              p.push();
              p.noFill();
              p.stroke(130,148,194, 55);
              p.strokeWeight(2.6*LOD);
              const y0 = obj.y + obj.h*0.38 - (obj.h*0.8*obj.liquidLevel) + Math.sin(obj.surfaceOsc)*1.3;
              p.arc(obj.x, y0, obj.w*0.85, obj.h*0.12, Math.PI, 2*Math.PI);
              p.pop();
            }
            // --- Glass highlight realism ---
            p.push();
            p.noFill();
            p.stroke(230,240,255, Math.floor(75*obj.glassReflectance*LOD));
            p.strokeWeight(2.2*LOD);
            p.arc(obj.x-obj.w/3, obj.y-obj.h/6, obj.w*0.55, obj.h*0.52, Math.PI*0.18,Math.PI*0.6);
            p.pop();
            // --- Gases ---
            if(obj.hasGas && obj.gasOpacity > 0.02) {
              p.push();
              p.noStroke();
              for(let i=0;i<Math.round(3*LOD);i++) {
                let fade = Math.max(0, obj.gasOpacity-(i*0.13));
                p.fill(210,230,255, Math.floor(130*fade*LOD));
                let cloudY = obj.y-obj.h/2-25-(i*15);
                p.ellipse(obj.x+(Math.sin(p.frameCount/13+i)*11),cloudY, obj.w*0.9 - i*9, 30-(i*6));
              }
              p.pop();
            }
            // --- Flame Flicker ---
            if((obj.type==='bunsen_burner'||obj.type==='candle') && obj.isLit) {
              p.push();
              const intensity = obj.flameIntensity||1;
              const shift = obj.flameOrientation||0;
              p.translate(obj.x+shift*22, obj.y-obj.h/2-18);
              // Outer flame
              p.noStroke();
              p.fill(255,172,29,Math.floor(180*intensity*LOD));
              p.beginShape();
              p.vertex(-8-7*shift,0);
              p.bezierVertex(-17, -27-intensity*18, 24, -27-intensity*19, 8+8*shift, 0);
              p.endShape(p.CLOSE);
              // Blue core
              if(obj.type==='bunsen_burner'){
                p.fill(44,180,255,188*intensity*LOD);
                p.beginShape();
                p.vertex(-5,0);
                p.bezierVertex(-3,-12-intensity*9,11,-13-intensity*9,5,0);
                p.endShape(p.CLOSE);
              }
              p.pop();
            }
            // --- Safety overlays (spills/overheat) ---
            if(obj.warning||obj.isOverheating){
              p.push();
              p.noFill();
              p.stroke(obj.warning?'#c53030':'#ffae00');
              p.strokeWeight(obj.warning?6:4);
              p.ellipse(obj.x,obj.y, obj.w+19*LOD, obj.h+19*LOD);
              // Flicker border
              if(obj.isOverheating){
                if(p.frameCount%8<4){
                  p.stroke(255,203,18,140); p.ellipse(obj.x,obj.y-obj.h/2, obj.w*0.68, obj.h*0.18); 
                }
              }
              p.pop();
              // Smoke if spill
              if(obj.warning==='SPILL'){
                p.push();
                for(let i=0;i<2*LOD;i++){
                  p.noStroke();
                  p.fill(180,170,166, 35*Math.random()+30);
                  p.ellipse(obj.x+(Math.random()-0.5)*obj.w*0.6,obj.y+obj.h/2+4+10*Math.random(),15+7*Math.random(),6+11*Math.random());
                }
                p.pop();
              }
            }
          };
          // Inject into p5 draw loop for engine-driven updates
          const _draw = p.draw;
          p.draw = function(){
            _draw.call(this);
            const apparatus = engine.p.getApparatus();
            for (const obj of apparatus) {
              p.constructor.prototype.displayApparatus.call(p, obj);
            }
            // Bench/room ambient overlays (soft light)
            p.push();
            p.noStroke();
            p.fill(255,255,255,27*LOD);
            p.rect(0,0, p.width,p.height*0.7);
            p.pop();
          };
        }
        setupVisualHooks();
      });
    </script>
</body>
</html>
